---
title: "BOX I.C.1.a.ii Transects for Monitoring Vegetation Response to Pumping"
subtitle: "Automated Data Processing and Statistical Report"
author: "Inyo County Water Department"
date: "2025-01-09"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(targets)
library(tidyverse)
library(rmarkdown)
library(DT)
library(htmlwidgets)
library(sf)
library(tmap)
library(tmaptools)
library(ggpmisc)
library(ggpubr)
library(gt)
library(glue)
library(ggdist)
library(here)
library(ggstatsplot)
library(janitor)
library(readxl)
library(patchwork)

# Global chunk options
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
options(tidyverse.quiet = TRUE)
```

```{r load-data}
# Example: Load data from your targets or other scripts
# (Adjust to your needs; remove if not required)
source(here("code","R","targets_functions.R"))
source(here("code","R","report_functions.R"))

# Load relevant target objects
# Todo: provide option to load data from motherduck public view or duckdb
# would preclude need to access _targets folder locally and move to hosted duckdb.
targets <- c(
  "species",
  "n_parcels_sampled",
  "cYear",
  "n_transects_sampled",
  "n_parcels_all_years",
  "parcel_test_sums",
  "monsites_shp",
  "icwd_ladwp_bind",
  "lpt_updated_master",
  "transects",
  "dtw_pfix",
  "rs_pfix",
  "parcels_shp",
  "parcels_deltas",
  "parcels_shp_ttest",
  "parcel_year_meta_combined_results",
  "deltas_ttest_att",
  "wellcont_means",
  "wellcont_means_rarefied",
  "plot_wellcontrol",
  "boxplot.w.c",
  "trends.w.c",
  "plot_1sample_timeseries",
  "plot_2sample_timeseries",
  "parcel_datatable",
  "parcel_datatable_chronic",
  "parcel_datatable_significant",
  "attributes_reinv",
  "parcels",
  "attributes_pfix",
  "panel_map_lw",
  "panel_map_bp",
  "panel_map_ta",
  "panel_map_ts",
  "panel_map_io",
  "panel_map_ss",
  "panel_map_bg",
  "parcel_year_meta_2samp_results_grass",
  "parcel_year_meta_1samp_results_grass",
  "parcel_year_meta_2samp_results",
  "parcel_year_meta_1samp_results",
  "canals_shp",
  "or_shp",
  "laa_shp",
  "lakes_shp",
  "streams_shp"
)

withr::with_dir(rprojroot::find_root('_targets.R'), tar_load(targets))
```

## Introduction

Vegetation in Owens Valley is monitored annually to quantify change in groundwater‑dependent plant communities and evaluate potential responses to pumping. This report implements **Green Book Section I.C.1.a**, using line‑point transect data to compare current conditions to the **1984–1987** baseline, contrast **Control** and **Wellfield** parcels, and apply standardized statistical tests for measurable change in cover and composition.\
Reference: [Green Book Section I.C.1.a](https://www.inyowater.org/wp-content/uploads/2017/09/GBMemo_SCfeb2017.pdf). Pumping management context: [Soil‑Plant Water Balance and Groundwater](https://inyo-gov.github.io/pumping-management/).

## Methods

Field methods are documented in Green Book Box I.C.1.a.ii (see reference link above). In summary, joint ICWD/LADWP line‑point transects are re‑measured annually at georeferenced locations to compare live cover and species composition to the 1984–1987 baseline and to detect measurable change over time. Methods follow the standing committee update (Feb 22, 2017) and include a consistent field protocol with annual calibration and shared data review.

### Data Processing (ETL)

The annual line‑point transect data are extracted from ICWD Google Sheets and LADWP CSVs, standardized, and compiled into a single analysis‑ready dataset. The core steps are:

1.  **Extract** raw parcel sheets (or cached snapshots) and LADWP cover files.\
2.  **Transform** to long format, harmonize species codes, and attach functional traits.\
3.  **Validate** transect coverage, remove duplicates, and track entity provenance.\
4.  **Merge** ICWD and LADWP datasets and append to the master dataset.\
5.  **Export** long and wide deliverables for QA/QC, reporting, and archiving.

In **`r cYear`**, the Inyo County Water Department (ICWD) and the Los Angeles Department of Water & Power (LADWP) jointly monitored **`r n_parcels_sampled`** vegetation parcels using **`r n_transects_sampled`** line-point intercept transects. Statistical tests compared current-year vegetation cover to the **1984-1987** baseline for **Wellfield** parcels (pumping-affected) and **Control** parcels (no pumping).

We compare parcel-level cover in the 1984-1987 baseline (Nominal Year 1986) to the current year (`r sprintf("<span style='color:#006d2c;font-size:1.05em;'>%s</span>", cYear)`) for **Wellfield** and **Control** parcels using the paired subset shown below. Results summarize differences in total cover, grass, and shrub cover between baseline and current-year conditions; statistical significance is shown on the plot for each cover type (ns = not significant; \* indicates p \< 0.05).

### Figure 1: Interactive Map (parcels sampled this past year)

Parcels sampled in **`r cYear`** are colored by **proportional grass change** (`pGrass_delta` = current year `pGrass` minus baseline `pGrass`). Red outlines indicate `Cover_sig.counter > 5` or `Grass_sig.counter > 5`. Zoom and pan to explore; click a parcel for details.

```{r}
#| label: fig-gbtype-interactive-map
#| fig-cap: "Interactive map: parcels sampled this past year, colored by grass proportion change (current vs baseline). Red outlines indicate Cover_sig.counter > 5 or Grass_sig.counter > 5."
#| fig-width: 4.5
#| fig-height: 5
#| column: page

tmap_mode("view")

# Compute proportional grass change (current year vs baseline)
pgrass_baseline <- parcels %>%
  filter(NominalYear == 1986) %>%
  select(Parcel, pGrass_baseline = pGrass)

pgrass_current <- parcels %>%
  filter(NominalYear == cYear) %>%
  select(Parcel, pGrass_current = pGrass)

pgrass_delta <- pgrass_current %>%
  left_join(pgrass_baseline, by = "Parcel") %>%
  mutate(pGrass_delta = pGrass_current - pGrass_baseline)

map_data <- parcels_shp_ttest %>%
  filter(!is.na(geometry)) %>%
  left_join(pgrass_delta, by = c("PCL_merged" = "Parcel")) %>%
  mutate(GB_TYPE.x = dplyr::coalesce(GB_TYPE.x, "Unknown")) %>%
  sf::st_transform(4326)

map_bbox <- sf::st_bbox(map_data)
map_center <- c(
  (map_bbox["xmin"] + map_bbox["xmax"]) / 2,
  (map_bbox["ymin"] + map_bbox["ymax"]) / 2
)

# Parcels with cover or grass below baseline 5+ years (red outline)
map_sig <- map_data %>%
  filter(
    dplyr::coalesce(Cover_sig.counter, 0) > 5 |
      dplyr::coalesce(Grass_sig.counter, 0) > 5
  )

# Interactive map: parcels only (all other layers commented out to keep widget small)
map_obj <- tm_basemap("Esri.WorldTopoMap") +
  tm_shape(map_data) +
  tm_polygons(
    col = "pGrass_delta",
    breaks = c(-1, -0.5, -0.25, -0.1, -0.05, 0.05, 0.1, 0.25, 0.5, 1),
    palette = "RdYlGn",
    title = "Grass proportion Δ",
    colorNA = "lightgray",
    textNA = "Missing",
    alpha = 0.7,
    border.col = "gray40",
    lwd = 1,
    id = "PCL_merged",
    popup.vars = c(
      "GB_TYPE.x", "COMM_NAME", "Grass.Delta", "Shrub.Delta", "Cover.Delta",
      "pGrass_baseline", "pGrass_current", "pGrass_delta",
      "Cover", "Grass", "Shrub",
      "Cover_sig.counter", "Grass_sig.counter", "Type"
    )
  )
if (nrow(map_sig) > 0) {
  map_obj <- map_obj +
    tm_shape(map_sig) +
    tm_borders(col = "red", lwd = 2)
}
map_obj <- map_obj +
  tm_view(set.view = c(map_center[1], map_center[2], 11))

# All other layers commented out (canals, streams, monsites, river, laa, lakes)
# to keep the Leaflet widget smaller so pandoc can finish:
# tm_shape(canals_shp) + tm_lines(...)
# tm_shape(streams_shp) + tm_lines(...) + tm_text("NAME", ...)
# tm_shape(monsites_shp) + tm_symbols(...) + tm_text("SITE", ...)
# tm_shape(or_shp) + tm_lines(...) + tm_text("NAME", ...)
# tm_shape(laa_shp) + tm_lines(...)
# tm_shape(lakes_shp) + tm_polygons(...)

map_obj

```

## Results

-   **Statistically below baseline**:
    -   `r sprintf("<span style='color:#006d2c;font-size:1.05em;'>%s</span>", sum((deltas_ttest_att$Type == "W") & ((deltas_ttest_att$Cover.Delta < 0) | (deltas_ttest_att$Grass.Delta < 0)), na.rm = TRUE))` wellfield parcels are below baseline this year (cover and/or perennial grass). Of these, `r sprintf("<span style='color:#006d2c;font-size:1.05em;'>%s</span>", sum((deltas_ttest_att[["Cover_sig.counter"]] > 5 | deltas_ttest_att[["Grass_sig.counter"]] > 5) & deltas_ttest_att$Type == "W", na.rm = TRUE))` have been below baseline for **5+** consecutive years. Filter **Cover_Yrs** or **Grass_Yrs** \> 0 in the table below to view below-baseline parcels in cover or perennial grass.

## Parcel Summary (Combined)

Table 1 summarizes current‑year parcel status for **Wellfield** parcels. Columns show baseline deltas (`Cover_D`, `Grass_D`, `Shrub_D`), years below baseline (`Cover_Yrs`, `Grass_Yrs`), chronic flag, cover types below baseline, and the last year at/above baseline (`Last_Base`, derived from the significance counters). Proportions (`pGrass`, `pShrub`) and current cover values (`Cover`, `Grass`, `Shrub`) are included for context, along with 2025 depth to water (`DTW`) and its percentile within the parcel’s DTW time series (`DTW_pct`, higher = shallower water).

### Table 1: Parcel Summary (Combined)

```{r tbl-parcel-summary-combined}
#| column: screen
last_year_if_nonneg <- function(year, delta) {
  yr <- year[!is.na(delta) & delta >= 0]
  if (length(yr) == 0) {
    return(NA_real_)
  }
  max(yr, na.rm = TRUE)
}

current_year_deltas <- deltas_ttest_att %>%
  filter(Type == "W") %>%
  mutate(
    below_cover = dplyr::coalesce(Cover_sig.counter, 0) > 0,
    below_grass = dplyr::coalesce(Grass_sig.counter, 0) > 0,
    below_shrub = Shrub.Delta < 0,
    below_types = pmap_chr(
      list(below_cover, below_grass, below_shrub),
      ~ paste(
        c(
          if (isTRUE(..1)) "Cover" else NULL,
          if (isTRUE(..2)) "Grass" else NULL,
          if (isTRUE(..3)) "Shrub" else NULL
        ),
        collapse = "/"
      )
    )
  )

last_year_from_counter <- function(counter, first_reinv_year) {
  if (is.na(counter)) return(NA_real_)
  inferred <- cYear - counter
  if (is.finite(first_reinv_year) && inferred < first_reinv_year) {
    return(1986)
  }
  inferred
}

first_reinv_years <- parcels_deltas %>%
  filter(NominalYear > 1986) %>%
  group_by(Parcel) %>%
  summarise(first_reinv_year = min(NominalYear, na.rm = TRUE), .groups = "drop")

parcel_summary <- current_year_deltas %>%
  left_join(first_reinv_years, by = "Parcel") %>%
  mutate(
    last_cover_year = mapply(last_year_from_counter, Cover_sig.counter, first_reinv_year),
    last_grass_year = mapply(last_year_from_counter, Grass_sig.counter, first_reinv_year),
    last_at_baseline = pmap_chr(
      list(below_types, last_cover_year, last_grass_year),
      function(types, lc, lg) {
        parts <- c()
        if (str_detect(types, "Cover") && is.finite(lc)) {
          parts <- c(parts, if (lc == 1986) "Cover baseline" else paste0("Cover ", lc))
        }
        if (str_detect(types, "Grass") && is.finite(lg)) {
          parts <- c(parts, if (lg == 1986) "Grass baseline" else paste0("Grass ", lg))
        }
        if (length(parts) == 0) NA_character_ else paste(parts, collapse = " / ")
      }
    ),
    chronic = ifelse(
      dplyr::coalesce(Cover_sig.counter, 0) > 5 |
        dplyr::coalesce(Grass_sig.counter, 0) > 5,
      "Yes",
      "No"
    )
  ) %>%
  left_join(
    {
      dtw_by_parcel_year <- dtw_pfix %>%
        group_by(Parcel, Year) %>%
        summarise(DTW = mean(DTW, na.rm = TRUE), .groups = "drop")

      dtw_by_parcel_year %>%
        group_by(Parcel) %>%
        mutate(
          rank = rank(DTW, ties.method = "min"),
          n = n(),
          DTW_pct = ifelse(n > 1, 100 * (1 - (rank - 1) / (n - 1)), NA_real_)
        ) %>%
        ungroup() %>%
        filter(Year == cYear) %>%
        select(Parcel, DTW, DTW_pct)
    },
    by = "Parcel"
  ) %>%
  select(
    Parcel,
    WF = wellfield,
    Type,
    GB = GB_TYPE,
    Cover_D = Cover.Delta,
    Grass_D = Grass.Delta,
    Shrub_D = Shrub.Delta,
    Cover_Yrs = Cover_sig.counter,
    Grass_Yrs = Grass_sig.counter,
    Chronic = chronic,
    Below = below_types,
    Last_Base = last_at_baseline,
    DTW,
    DTW_pct,
    pGrass,
    pShrub,
    Cover,
    Grass,
    Shrub
  ) %>%
  arrange(desc(Chronic), Parcel)

DT::datatable(
  parcel_summary,
  filter = "top",
  options = list(
    dom = "Blfrtip",
    buttons = c("copy", "csv", "excel", "pdf", "print"),
    scrollX = TRUE,
    scrollCollapse = TRUE,
    autoWidth = FALSE,
    pageLength = 10
  ),
  width = "100%",
  class = "compact stripe nowrap"
) %>%
  DT::formatRound(
    columns = c("Cover_D", "Grass_D", "Shrub_D", "DTW", "DTW_pct", "pGrass", "pShrub", "Cover", "Grass", "Shrub"),
    digits = 1
  )
```

Table 2 lists **control and other parcels** (all parcels not in the wellfield group): Type = Control (C) or Type NA/blank. Same columns as Table 1.

### Table 2: Control and other parcels (non-wellfield)

```{r tbl-control-parcels}
#| column: screen
control_year_deltas <- deltas_ttest_att %>%
  filter(Type != "W" | is.na(Type)) %>%
  mutate(
    below_cover = dplyr::coalesce(Cover_sig.counter, 0) > 0,
    below_grass = dplyr::coalesce(Grass_sig.counter, 0) > 0,
    below_shrub = Shrub.Delta < 0,
    below_types = pmap_chr(
      list(below_cover, below_grass, below_shrub),
      ~ paste(
        c(
          if (isTRUE(..1)) "Cover" else NULL,
          if (isTRUE(..2)) "Grass" else NULL,
          if (isTRUE(..3)) "Shrub" else NULL
        ),
        collapse = "/"
      )
    )
  )

control_summary <- control_year_deltas %>%
  left_join(first_reinv_years, by = "Parcel") %>%
  mutate(
    last_cover_year = mapply(last_year_from_counter, Cover_sig.counter, first_reinv_year),
    last_grass_year = mapply(last_year_from_counter, Grass_sig.counter, first_reinv_year),
    last_at_baseline = pmap_chr(
      list(below_types, last_cover_year, last_grass_year),
      function(types, lc, lg) {
        parts <- c()
        if (str_detect(types, "Cover") && is.finite(lc)) {
          parts <- c(parts, if (lc == 1986) "Cover baseline" else paste0("Cover ", lc))
        }
        if (str_detect(types, "Grass") && is.finite(lg)) {
          parts <- c(parts, if (lg == 1986) "Grass baseline" else paste0("Grass ", lg))
        }
        if (length(parts) == 0) NA_character_ else paste(parts, collapse = " / ")
      }
    ),
    chronic = ifelse(
      dplyr::coalesce(Cover_sig.counter, 0) > 5 |
        dplyr::coalesce(Grass_sig.counter, 0) > 5,
      "Yes",
      "No"
    )
  ) %>%
  left_join(
    dtw_pfix %>%
      group_by(Parcel, Year) %>%
      summarise(DTW = mean(DTW, na.rm = TRUE), .groups = "drop") %>%
      group_by(Parcel) %>%
      mutate(
        rank = rank(DTW, ties.method = "min"),
        n = n(),
        DTW_pct = ifelse(n > 1, 100 * (1 - (rank - 1) / (n - 1)), NA_real_)
      ) %>%
      ungroup() %>%
      filter(Year == cYear) %>%
      select(Parcel, DTW, DTW_pct),
    by = "Parcel"
  ) %>%
  select(
    Parcel,
    WF = wellfield,
    Type,
    GB = GB_TYPE,
    Cover_D = Cover.Delta,
    Grass_D = Grass.Delta,
    Shrub_D = Shrub.Delta,
    Cover_Yrs = Cover_sig.counter,
    Grass_Yrs = Grass_sig.counter,
    Chronic = chronic,
    Below = below_types,
    Last_Base = last_at_baseline,
    DTW,
    DTW_pct,
    pGrass,
    pShrub,
    Cover,
    Grass,
    Shrub
  ) %>%
  arrange(desc(Chronic), Parcel)

DT::datatable(
  control_summary,
  filter = "top",
  options = list(
    dom = "Blfrtip",
    buttons = c("copy", "csv", "excel", "pdf", "print"),
    scrollX = TRUE,
    scrollCollapse = TRUE,
    autoWidth = FALSE,
    pageLength = 10
  ),
  width = "100%",
  class = "compact stripe nowrap"
) %>%
  DT::formatRound(
    columns = c("Cover_D", "Grass_D", "Shrub_D", "DTW", "DTW_pct", "pGrass", "pShrub", "Cover", "Grass", "Shrub"),
    digits = 1
  )
```

### Below vs. above baseline by group

Below baseline = cover and/or perennial grass below baseline in the current year (`Cover.Delta` \< 0 or `Grass.Delta` \< 0).

```{r tbl-below-above-pct}
#| column: screen
below_baseline <- (deltas_ttest_att$Cover.Delta < 0) | (deltas_ttest_att$Grass.Delta < 0)
deltas_ttest_att$below_baseline <- below_baseline

pct_by_group <- deltas_ttest_att %>%
  mutate(
    group = if_else(Type == "W", "Wellfield", "Control / other")
  ) %>%
  group_by(group) %>%
  summarise(
    N = n(),
    N_below = sum(below_baseline, na.rm = TRUE),
    N_above = N - N_below,
    Pct_below = round(100 * N_below / N, 1),
    Pct_above = round(100 * N_above / N, 1),
    .groups = "drop"
  ) %>%
  select(Group = group, N, `N below baseline` = N_below, `N at/above baseline` = N_above, `% below` = Pct_below, `% above` = Pct_above)

knitr::kable(pct_by_group, align = c("l", "r", "r", "r", "r", "r"))
```

## Wellfield vs. Control Group Comparison

```{r wellfield-control-plot, fig.width=9, fig.height=5, fig.cap="Figure: Baseline (1986) versus current year cover by parcel type. Boxplots summarize total cover, grass, and shrub for control and wellfield parcels; significance labels indicate baseline vs current-year differences."}
# Boxplots with white background theme (no mean markers)
boxplot.w.c +
  scale_x_discrete(labels = c(C = "Control", W = "Wellfield")) +
  labs(x = "Parcel Type") +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(color = "gray90", linewidth = 0.5),
    panel.grid.minor = element_line(color = "gray95", linewidth = 0.25),
    strip.background = element_rect(fill = "white", color = "gray80"),
    strip.text = element_text(color = "black", face = "bold")
  )
```

```{r wellfield-control-text, results='asis'}
box_data <- boxplot.w.c$data %>%
  rename(cover_type = `Cover.Type`, value = Cover) %>%
  filter(NominalYear %in% c(1986, cYear)) %>%
  group_by(Type, NominalYear, cover_type) %>%
  summarise(value = median(value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = NominalYear,
    values_from = value,
    names_prefix = "Year_"
  )

fmt_delta <- function(current, baseline) {
  if (is.na(current) || is.na(baseline)) return("NA")
  delta <- round(current - baseline, 1)
  sprintf("%+.1f%%", delta)
}

fmt_pair <- function(current, baseline) {
  if (is.na(current) || is.na(baseline)) return("NA")
  paste0(round(baseline, 1), "% baseline vs ", round(current, 1), "% current")
}

get_vals <- function(type_label, cover_label) {
  row <- box_data %>%
    filter(Type == type_label, cover_type == cover_label)
  baseline <- row[[paste0("Year_", 1986)]]
  current <- row[[paste0("Year_", cYear)]]
  list(baseline = baseline, current = current)
}

control_cover <- get_vals("C", "Cover")
control_grass <- get_vals("C", "Grass")
control_shrub <- get_vals("C", "Shrub")
wellfield_cover <- get_vals("W", "Cover")
wellfield_grass <- get_vals("W", "Grass")
wellfield_shrub <- get_vals("W", "Shrub")

control_text <- glue::glue(
  "Control parcels (no pumping) show cover {fmt_pair(control_cover$current, control_cover$baseline)} ",
  "(Δ {fmt_delta(control_cover$current, control_cover$baseline)}), ",
  "grass {fmt_pair(control_grass$current, control_grass$baseline)} ",
  "(Δ {fmt_delta(control_grass$current, control_grass$baseline)}), ",
  "and shrub {fmt_pair(control_shrub$current, control_shrub$baseline)} ",
  "(Δ {fmt_delta(control_shrub$current, control_shrub$baseline)})."
)

wellfield_text <- glue::glue(
  "Wellfield parcels (pumping-affected) show cover {fmt_pair(wellfield_cover$current, wellfield_cover$baseline)} ",
  "(Δ {fmt_delta(wellfield_cover$current, wellfield_cover$baseline)}), ",
  "grass {fmt_pair(wellfield_grass$current, wellfield_grass$baseline)} ",
  "(Δ {fmt_delta(wellfield_grass$current, wellfield_grass$baseline)}), ",
  "and shrub {fmt_pair(wellfield_shrub$current, wellfield_shrub$baseline)} ",
  "(Δ {fmt_delta(wellfield_shrub$current, wellfield_shrub$baseline)})."
)

cat(control_text, "\n\n", wellfield_text, "\n\n")
cat("Values reflect median parcel cover within each group. Significance labels on the figure summarize baseline vs current-year tests for each cover metric within parcel type (ns = not significant; * indicates p < 0.05).")
```

```{r wellfield-control-multiyear-plot, fig.width=9, fig.height=5, fig.cap="Figure: Cover by parcel type for baseline (1986), previous year, and current year. Boxplots summarize total cover, grass, and shrub for control and wellfield parcels."}
pYear <- cYear - 1
parcels_multi <- parcels %>%
  left_join(attributes_pfix %>% select(Parcel, Type), by = "Parcel") %>%
  filter(NominalYear %in% c(1986, pYear, cYear), !is.na(Type)) %>%
  select(Parcel, NominalYear, Type, Cover, Grass, Shrub) %>%
  tidyr::pivot_longer(c(Cover, Grass, Shrub), names_to = "Cover.Type", values_to = "Cover")

ggplot(parcels_multi, aes(x = Type, y = Cover, color = as.factor(NominalYear))) +
  geom_boxplot() +
  facet_wrap(~ Cover.Type) +
  scale_x_discrete(labels = c(C = "Control", W = "Wellfield")) +
  labs(x = "Parcel Type", color = "Year") +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    strip.background = element_rect(fill = "white", color = "gray80"),
    strip.text = element_text(face = "bold")
  )
```

## Parcel Trends Over Time

```{r fig-trends-over-time, fig.width=6.5, fig.height=4.3, fig.cap="Figure: Trends in parcel-group cover over time. Lines show linear fits; p-values report whether slope differs from zero within each parcel group and cover type."}
trends.w.c
```

```{r fig-trends-over-time-text, results='asis'}
trend_data <- trends.w.c$data %>%
  rename(cover_type = `Cover.Type`, value = Cover) %>%
  group_by(Type, cover_type) %>%
  summarise(
    p_value = summary(lm(value ~ NominalYear))$coefficients[2, 4],
    .groups = "drop"
  )

fmt_p <- function(x) ifelse(is.na(x), "NA", formatC(x, digits = 2, format = "g"))

control_cover_p <- trend_data %>% filter(Type == "Control", cover_type == "Cover") %>% pull(p_value)
control_grass_p <- trend_data %>% filter(Type == "Control", cover_type == "Grass") %>% pull(p_value)
control_shrub_p <- trend_data %>% filter(Type == "Control", cover_type == "Shrub") %>% pull(p_value)
wellfield_cover_p <- trend_data %>% filter(Type == "Wellfield", cover_type == "Cover") %>% pull(p_value)
wellfield_grass_p <- trend_data %>% filter(Type == "Wellfield", cover_type == "Grass") %>% pull(p_value)
wellfield_shrub_p <- trend_data %>% filter(Type == "Wellfield", cover_type == "Shrub") %>% pull(p_value)

cat(glue::glue(
  "Control parcels show no statistically significant linear trends in cover (P = {fmt_p(control_cover_p)}), grass (P = {fmt_p(control_grass_p)}), or shrub (P = {fmt_p(control_shrub_p)}). ",
  "Wellfield parcels show statistically significant increasing linear trends in cover (P = {fmt_p(wellfield_cover_p)}) and shrub (P = {fmt_p(wellfield_shrub_p)}), ",
  "while grass shows no statistically significant trend (P = {fmt_p(wellfield_grass_p)})."
))
```

## Parcel Profiles (QA/QC)

Parcel profiles are now provided on a dedicated page: [Parcel Profiles — QA/QC (All Parcels)](parcel_profiles.html). This page includes **all parcels** organized by wellfield from north to south — **Laws**, **Control**, **Big Pine**, **Taboose-Aberdeen**, **Thibaut Sawmill**, **Independence Oak**, **Symmes Shepherd**, **Bairs Georges** — with control parcels distributed throughout the valley just outside the zone of pumping influence.

## Discussion

Vegetation in Owens Valley is monitored annually to detect and attribute changes potentially caused by groundwater pumping. This approach follows **Green Book Section I.C.1.a**, which sets out procedures for determining whether decreases in perennial cover are **measurable** (statistically significant).

### Green Book and Baseline

-   **Green Book**\
    Provides criteria for evaluating measurable vegetation changes, including the use of baseline data from 1984-1987 and statistical tests.

-   **1984-1987 Baseline**\
    LADWP inventoried and mapped vegetation across 2,126 parcels. Groundwater-dependent parcels (Types B, C, D, E) serve as focal points for assessing pumping-induced drawdown effects.

### Interpretation

**Direction of trends (with statistical significance):** Control parcel group average shows no statistically significant linear trends in cover, grass, or shrub. Wellfield parcel group average shows statistically significant **increasing** linear trends in cover and shrub; wellfield perennial grass shows no statistically significant trend within this subset. P-values are reported in the “Parcel Trends Over Time” section above.

**Flagged parcels:** Flagged parcels indicate measurable (statistically significant) deviations from baseline. Whether these changes are attributable to pumping vs. other factors (e.g., drought, land use) are evaluated under **Green Book Section I.C.1.b**.

## Appendix

### References

-   [Green Book Section I.C.1.a](https://www.inyowater.org/wp-content/uploads/2017/09/GBMemo_SCfeb2017.pdf)\
-   Inyo-LA Water Agreement (1991)\
-   Additional scripts and details: [GitHub repository](https://inyo-gov.github.io/vegetation-condition/)\
-   Attributability analyses (I.C.1.b): [green-book-IC1b](https://github.com/inyo-gov/green-book-IC1b)